<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mining Microgrid Simulator</title>

<!-- ===== Styles ===== -->
<style>
:root{
  --page-bg:#f8f9fb; --card-bg:#fff; --border:#e6e8ef; --text:#1f2430;
  --muted:#6b7280; --brand:#0b78ff; --ok:#16a34a; --warn:#f59e0b; --bad:#e11d48;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--page-bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto;padding:16px}
h1{margin:0 0 10px;font-size:18px}
h2{margin:8px 0 10px;font-size:16px}
.card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:12px}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:320px 1fr}
@media (max-width:1080px){.grid-2{grid-template-columns:1fr}}
.row{display:grid;grid-template-columns:1fr;gap:12px}
.ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn.is-busy{opacity:.7;pointer-events:none;position:relative}
.btn.is-busy::after{content:"";position:absolute;right:10px;top:50%;width:12px;height:12px;margin-top:-6px;border:2px solid rgba(0,0,0,.2);border-top-color:var(--brand);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
label{color:var(--muted);font-size:12px;margin-right:6px}
input[type="number"],select{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff;min-width:72px}
input[type="range"]{width:240px}
fieldset{border:1px dashed var(--border);border-radius:10px;margin:0 0 10px;padding:8px}
legend{font-size:12px;color:var(--muted);padding:0 6px}
.small{font-size:12px;color:var(--muted)}
.badge{padding:2px 6px;border-radius:999px;font-size:12px}
.badge.ok{background:#e8faf0;color:#065f46}
.badge.warn{background:#fff7ed;color:#92400e}
.badge.bad{background:#fef2f2;color:#991b1b}

canvas{width:100%;height:360px;display:block}
.status{font-family:ui-monospace,Consolas,monaco,monospace;color:#394150;font-size:12px;padding:6px 10px;border-radius:8px;background:#f1f3f9;border:1px dashed #d7dbe7}
.kpis{display:grid;grid-template-columns:repeat(8,1fr);gap:10px}
@media (max-width:1280px){.kpis{grid-template-columns:repeat(4,1fr)}}
@media (max-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:10px}
.kpi b{display:block;font-size:12px;color:var(--muted);margin-bottom:2px}
.kpi span{font-weight:600}
.log{height:160px;overflow:auto;background:#0b1220;color:#e2e8f0;border-radius:10px;padding:8px;font:12px/1.4 ui-monospace,Consolas,monaco,monospace}
.log b{color:#93c5fd}
footer.site-footer{background:var(--page-bg);color:#333;border-top:1px solid var(--border);padding:18px 16px;font-size:13px}
footer.site-footer a{color:var(--brand);text-decoration:none}
footer.site-footer a:hover{text-decoration:underline}
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:rgba(0,0,0,.78);color:#fff;padding:8px 14px;border-radius:8px;font-size:12px;z-index:9999;opacity:0;transition:opacity .2s}
.toast.show{opacity:1}
.legend{font-size:12px;color:#6b7280}
hr.sep{border:none;border-top:1px solid var(--border);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">

  <!-- ===== Header & Controls ===== -->
  <div class="card">
    <div class="ctrl" role="group" aria-label="simulation controls">
      <button id="btnStart" class="btn">▶ Start</button>
      <button id="btnPause" class="btn">⏸ Pause</button>
      <button id="btnReset" class="btn">⟲ Reset</button>
      <span class="legend" style="margin-left:10px">
        Legend：PV=<span style="color:#E69F00">orange</span>，
        Wind=<span style="color:#D55E00">vermillion</span>，
        Load=<span style="color:#000">black</span>，
        Diesel=<span style="color:#0072B2">blue</span>，
        BESS(+dis/−ch)=<span style="color:#009E73">green</span>
      </span>
    </div>
    <div class="ctrl" style="margin-top:10px">
      <label><input id="followLive" type="checkbox" checked> 跟随实时</label>
      <label>窗口长度 (h)</label>
      <input id="winLen" type="number" min="0.5" step="0.5" value="4">
      <label>窗口起点 (h)</label>
      <input id="winStart" type="range" min="0" max="24" step="0.1" value="0">
      <span class="legend" id="winText">[0.0, 4.0] h</span>
    </div>
  </div>

  <!-- ===== Main Grid ===== -->
  <div class="grid grid-2" style="margin-top:12px">
    <!-- ==== Left: Config Panel ==== -->
    <div class="card">
      <h2>配置面板</h2>

      <fieldset>
        <legend>位置/昼夜</legend>
        <div class="ctrl">
          <label>Region</label>
          <select id="region">
            <option value="arctic">Arctic (极寒)</option>
            <option value="desert">Desert (沙漠)</option>
            <option value="tropic">Tropic (热带)</option>
            <option value="custom" selected>Custom</option>
          </select>
        </div>
        <div class="ctrl" style="margin-top:6px">
          <label>日出 (h)</label><input id="sunrise" type="number" min="0" max="24" step="0.1" value="6">
          <label>日落 (h)</label><input id="sunset"  type="number" min="0" max="24" step="0.1" value="18">
        </div>
        <div class="small">注：仅用于 PV 曲线合成展示；引擎口径以私库为准。</div>
      </fieldset>

      <fieldset>
        <legend>负载</legend>
        <div class="ctrl">
          <label>P<sub>load,avg</sub> (MW)</label><input id="loadAvg" type="number" step="0.1" value="12">
          <label>波动幅 (MW)</label><input id="loadSwing" type="number" step="0.1" value="1.2">
          <label>周期 (h)</label><input id="loadPeriod" type="number" step="0.1" value="4">
        </div>
      </fieldset>

      <fieldset>
        <legend>PV / Wind</legend>
        <div class="ctrl">
          <label>PV 上限 (MW)</label><input id="pvMax" type="number" step="0.1" value="24">
          <label>风均值 (MW)</label><input id="windAvg" type="number" step="0.1" value="3">
        </div>
        <div class="small">将作为 UI 端可视化的参考包络。实际调度以引擎为准。</div>
      </fieldset>

      <fieldset>
        <legend>BESS</legend>
        <div class="ctrl">
          <label>P<sub>max</sub> (MW)</label><input id="bessP" type="number" step="0.1" value="8">
          <label>E<sub>max</sub> (MWh)</label><input id="bessE" type="number" step="0.1" value="20">
          <label>目标 SOC (%)</label><input id="bessSoct" type="number" step="1" value="70">
        </div>
      </fieldset>

      <fieldset>
        <legend>Diesel（VF）/ N–1 / 谐波</legend>
        <div class="ctrl">
          <label>3.3MW 台数</label><input id="dg33" type="number" step="1" value="3">
          <label>1.25MW 台数</label><input id="dg12" type="number" step="1" value="0">
        </div>
        <div class="small">N–1 校核与谐波仅示意位；最终以现场 PQ/保护测量为准。</div>
      </fieldset>

      <hr class="sep"/>
      <div class="small">若需更细参数（droop、虚拟惯量、限速、低压穿越等），请在私库引擎里调整；此处仅作可视化和调度侧窗口。</div>
    </div>

    <!-- ==== Right: Charts & KPIs ==== -->
    <div class="grid" style="gap:12px">
      <div class="card">
        <h2>功率（MW）· 视窗</h2>
        <canvas id="powerChart" aria-label="Power window chart"></canvas>
      </div>
      <div class="card">
        <h2>频率（Hz）/ SOC（%）· 视窗</h2>
        <canvas id="freqChart" aria-label="Frequency & SOC window chart"></canvas>
      </div>

      <div class="card">
        <div id="status" class="status">—</div>
      </div>

      <div class="kpis">
        <div class="kpi"><b>燃油消耗</b><span id="k_fuelUsed">0 L</span></div>
        <div class="kpi"><b>燃油对照</b><span id="k_fuelBase">0 L</span></div>
        <div class="kpi"><b>燃油节省</b><span id="k_fuelSaved">0 L</span></div>
        <div class="kpi"><b>可再生占比</b><span id="k_renShare">0 %</span></div>
        <div class="kpi"><b>PV 发电量</b><span id="k_pvE">0 MWh</span></div>
        <div class="kpi"><b>Wind 发电量</b><span id="k_windE">0 MWh</span></div>
        <div class="kpi"><b>弃电（PV+风）</b><span id="k_curtail">0 MWh</span></div>
        <div class="kpi"><b>N–1 校核</b><span id="k_n1" class="badge ok">OK</span></div>
      </div>

      <div class="card">
        <h2 style="margin-bottom:6px">日志</h2>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer">
  © 2025 Energize Solutions Inc. – All rights reserved.
  Powered by GitHub Pages | Contact: <a href="mailto:info@energizeos.com">info@energizeos.com</a>
  <span style="margin-left:10px;">
    <a href="https://www.linkedin.com/in/gongtiejing" target="_blank" rel="noopener">LinkedIn</a> ·
    <a href="https://github.com/enxpower/mining-sim" target="_blank" rel="noopener">GitHub</a>
  </span>
</footer>
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<!-- ===== Scripts ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script type="module">
/* -------------------- Color palette -------------------- */
const C = { pv:'#E69F00', wind:'#D55E00', load:'#000', diesel:'#0072B2', bess:'#009E73', freq:'#6A5ACD', soc:'#2E8B57', dotted:'#9aa4b2' };

/* -------------------- Toast -------------------- */
const toast = (msg)=>{
  const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),1200);
};

/* -------------------- Engine adapter (private bundle + shim) -------------------- */
const ENGINE_PATH = '../public/vendor/ems-engine.min.js';
async function loadEngine(cfg){
  try{
    const mod = await import(ENGINE_PATH + '?v=' + Date.now());
    const factory = mod.createEngine || mod.default?.createEngine || mod.default;
    if (typeof factory !== 'function') throw new Error('factory missing');
    return factory(cfg);
  }catch(e){
    console.warn('[engine] load failed, use shim:', e);
    toast('Engine bundle missing, using demo shim');
    return shimEngine();
  }
}
// very small shim (keeps UI alive). time step≈1s
function shimEngine(){
  let ticking=false, timer=null, cb=()=>{};
  const S={ t:0, hz:60, soc:70, pv:0, wind:0, load:12, diesel:12, bess:0 };
  const K={ fuelUsedL:0, fuelBaselineL:0, fuelSavedL:0, renewableShare:0,
            pvEnergyMWh:0, windEnergyMWh:0, curtailMWh:0, n1ok:true };
  function integ(){
    const ren=Math.max(0,S.pv+S.wind), curt=Math.max(0,ren-S.load);
    K.curtailMWh+=curt/360; K.pvEnergyMWh+=Math.max(0,S.pv)/360; K.windEnergyMWh+=Math.max(0,S.wind)/360;
    K.fuelUsedL+=Math.max(0,S.diesel)*0.22*10; K.fuelBaselineL+=Math.max(0,S.load)*0.22*10;
    K.fuelSavedL=Math.max(0,K.fuelBaselineL-K.fuelUsedL);
    const total=K.pvEnergyMWh+K.windEnergyMWh+(K.fuelUsedL/0.22/1000);
    K.renewableShare= total>0 ? (K.pvEnergyMWh+K.windEnergyMWh)/total : 0;
    K.n1ok=true;
  }
  return {
    start(){ if(ticking) return; ticking=true; timer=setInterval(()=>{
      S.t += 1/12;
      // synthetic PV with sunrise/sunset from UI
      const sr=Number(document.getElementById('sunrise').value||6);
      const ss=Number(document.getElementById('sunset').value||18);
      const span=Math.max(0, ss-sr);
      const h=S.t%24;
      const pvMax=Number(document.getElementById('pvMax').value||24);
      S.pv = (h>sr && h<ss) ? pvMax*Math.sin(Math.PI*(h-sr)/span) : 0;

      const wAvg=Number(document.getElementById('windAvg').value||3);
      S.wind = wAvg + Math.sin(S.t*3)*0.7 + Math.cos(S.t*1.3)*0.5;

      const lAvg=Number(document.getElementById('loadAvg').value||12);
      const lSw =Number(document.getElementById('loadSwing').value||1.2);
      const lPer=Number(document.getElementById('loadPeriod').value||4);
      S.load = lAvg + Math.sin(S.t*2*Math.PI/lPer)*lSw;

      const ren = Math.max(0, S.pv + S.wind);
      const net = S.load - ren;
      S.diesel = Math.max(0, Math.min(10, net*0.8));
      const rest = net - S.diesel;
      S.bess = -rest; // 放正充负
      S.soc  = Math.max(15, Math.min(95, S.soc + (-rest)*0.05));
      S.hz   = 60 + (-rest)*0.02 + Math.sin(S.t*4)*0.02;

      integ(); cb(structuredClone(S));
    }, 1000);},
    pause(){ ticking=false; clearInterval(timer); },
    reset(){ this.pause(); Object.assign(S,{t:0,hz:60,soc:70,pv:0,wind:0,load:12,diesel:12,bess:0});
             Object.assign(K,{fuelUsedL:0,fuelBaselineL:0,fuelSavedL:0,renewableShare:0,pvEnergyMWh:0,windEnergyMWh:0,curtailMWh:0,n1ok:true}); },
    onTick(fn){ cb=fn; },
    getState(){ return structuredClone(S); },
    getKpis(){ return structuredClone(K); }
  };
}

/* -------------------- Charts -------------------- */
let powerChart,freqChart;
function createCharts(){
  const ctxP=document.getElementById('powerChart');
  const ctxF=document.getElementById('freqChart');
  const common={responsive:true,animation:false,parsing:false,normalized:true,maintainAspectRatio:false};
  powerChart=new Chart(ctxP,{type:'line',data:{datasets:[
    {label:'PV',data:[],borderColor:C.pv,pointRadius:0,tension:.25},
    {label:'Wind',data:[],borderColor:C.wind,pointRadius:0,tension:.25,borderDash:[6,4]},
    {label:'Load',data:[],borderColor:C.load,pointRadius:0,tension:.25,borderWidth:1.5},
    {label:'Diesel',data:[],borderColor:C.diesel,pointRadius:0,tension:.25},
    {label:'BESS (+dis/-ch)',data:[],borderColor:C.bess,pointRadius:0,tension:.25}
  ]}, options:{...common, scales:{x:{type:'linear',min:0,max:4,ticks:{callback:v=>v.toFixed(1)+'h'}}, y:{title:{display:true,text:'MW'}}}, plugins:{legend:{position:'right'}}});
  freqChart=new Chart(ctxF,{type:'line',data:{datasets:[
    {label:'Freq',data:[],borderColor:C.freq,pointRadius:0,tension:.15},
    {label:'SOC', data:[],borderColor:C.soc, pointRadius:0,tension:.15,yAxisID:'y2'},
    {label:'f₀=60 Hz baseline',data:[{x:0,y:60},{x:4,y:60}],borderColor:C.dotted,borderDash:[4,4],pointRadius:0}
  ]}, options:{...common, scales:{x:{type:'linear',min:0,max:4,ticks:{callback:v=>v.toFixed(1)+'h'}}, y:{title:{display:true,text:'Hz'},min:55,max:65}, y2:{position:'right',title:{display:true,text:'SOC %'},min:0,max:100,grid:{display:false}}}, plugins:{legend:{position:'right'}}});
}
function setWindow(x0,x1){
  powerChart.options.scales.x.min=x0; powerChart.options.scales.x.max=x1;
  freqChart.options.scales.x.min=x0;  freqChart.options.scales.x.max=x1;
  freqChart.data.datasets[2].data=[{x:x0,y:60},{x:x1,y:60}];
  powerChart.update('none'); freqChart.update('none');
}

/* -------------------- Buffers & redraw -------------------- */
const buf={t:[],pv:[],wind:[],load:[],diesel:[],bess:[],hz:[],soc:[]};
function push(S){
  const cap=24*60*6;
  const push=(a,v)=>{a.push(v); if(a.length>cap) a.shift();};
  push(buf.t,S.t); push(buf.pv,S.pv); push(buf.wind,S.wind); push(buf.load,S.load);
  push(buf.diesel,S.diesel); push(buf.bess,S.bess); push(buf.hz,S.hz); push(buf.soc,S.soc);
}
function redraw(x0,x1){
  const idx=buf.t.reduce((acc,v,i)=>{ if(v>=x0&&v<=x1) acc.push(i); return acc; },[]);
  const pack=(a)=>idx.map(i=>({x:buf.t[i],y:a[i]}));
  powerChart.data.datasets[0].data=pack(buf.pv);
  powerChart.data.datasets[1].data=pack(buf.wind);
  powerChart.data.datasets[2].data=pack(buf.load);
  powerChart.data.datasets[3].data=pack(buf.diesel);
  powerChart.data.datasets[4].data=pack(buf.bess);
  freqChart.data.datasets[0].data =pack(buf.hz);
  freqChart.data.datasets[1].data =pack(buf.soc);
  powerChart.update('none'); freqChart.update('none');
}

/* -------------------- KPI & log -------------------- */
const setText=(id,txt)=>{const el=document.getElementById(id); if(el) el.textContent=txt;};
function renderKpis(k){
  setText('k_fuelUsed',  `${Math.max(0,k.fuelUsedL||0).toFixed(0)} L`);
  setText('k_fuelBase',  `${Math.max(0,k.fuelBaselineL||0).toFixed(0)} L`);
  setText('k_fuelSaved', `${Math.max(0,k.fuelSavedL||0).toFixed(0)} L`);
  setText('k_renShare',  `${Math.round(Math.max(0,Math.min(1,k.renewableShare||0))*1000)/10} %`);
  setText('k_pvE',       `${Math.max(0,k.pvEnergyMWh||0).toFixed(2)} MWh`);
  setText('k_windE',     `${Math.max(0,k.windEnergyMWh||0).toFixed(2)} MWh`);
  setText('k_curtail',   `${Math.max(0,k.curtailMWh||0).toFixed(2)} MWh`);
  const n1 = document.getElementById('k_n1'); n1.textContent = (k.n1ok===false?'Not Met':'OK'); n1.className='badge '+(k.n1ok===false?'bad':'ok');
}
function logLine(s){ const el=document.getElementById('log'); if(!el) return;
  const ts = new Date().toLocaleTimeString('en-CA',{hour12:false});
  el.insertAdjacentHTML('afterbegin', `<div>[<b>${ts}</b>] ${s}</div>`); }

/* -------------------- Bootstrap -------------------- */
createCharts();
const btnStart=document.getElementById('btnStart');
const btnPause=document.getElementById('btnPause');
const btnReset=document.getElementById('btnReset');
const follow =document.getElementById('followLive');
const winLen =document.getElementById('winLen');
const winStart=document.getElementById('winStart');
const winText =document.getElementById('winText');
const statusEl=document.getElementById('status');

function refreshView(){
  const w=Number(winLen.value||4), s=Number(winStart.value||0);
  winText.textContent=`[${s.toFixed(1)}, ${(s+w).toFixed(1)}] h`;
  setWindow(s,s+w); redraw(s,s+w);
}

const engine = await loadEngine({});
engine.onTick((S)=>{
  push(S);
  if (follow.checked){
    const w=Number(winLen.value||4); const s0=Math.max(0, S.t - w);
    winStart.value=s0;
  }
  refreshView();

  statusEl.textContent =
    `t=${S.t.toFixed(2)} h | f=${(S.hz??0).toFixed(3)} Hz | Δf=${((S.hz??0)-60).toFixed(3)} Hz | `+
    `PV=${(S.pv??0).toFixed(2)} MW | Wind=${(S.wind??0).toFixed(2)} MW | Diesel=${(S.diesel??0).toFixed(2)} MW | `+
    `BESS=${(S.bess??0).toFixed(2)} MW | SOC=${(S.soc??0).toFixed(1)} % | Load=${(S.load??0).toFixed(2)} MW`;

  if (typeof engine.getKpis === 'function'){
    renderKpis(engine.getKpis());
  }
});

btnStart.addEventListener('click', async()=>{ btnStart.classList.add('is-busy'); try{ await engine.start(); toast('Started'); logLine('启动命令：开始仿真'); } finally{ btnStart.classList.remove('is-busy'); }});
btnPause.addEventListener('click', async()=>{ btnPause.classList.add('is-busy'); try{ await engine.pause(); toast('Paused'); logLine('指令：暂停'); } finally{ btnPause.classList.remove('is-busy'); }});
btnReset.addEventListener('click', async()=>{ btnReset.classList.add('is-busy'); try{ await engine.reset(); Object.keys(buf).forEach(k=>buf[k]=[]);
  refreshView(); toast('Reset'); logLine('指令：重置'); } finally{ btnReset.classList.remove('is-busy'); }});

winLen.addEventListener('change', refreshView);
winStart.addEventListener('input', ()=>{ follow.checked=false; refreshView(); });

refreshView();
</script>
</body>
</html>
