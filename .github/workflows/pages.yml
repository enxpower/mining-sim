name: Build & Deploy Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  OWNER: enxpower                 # ← 改成你的组织/账号
  ENGINE_REPO: ems-engine         # ← 私库名
  ENGINE_TAG: latest              # ← 取 latest release
  ENGINE_PAT: ${{ secrets.ENGINE_PAT }}  # ← PAT，需要有读私库 release 权限

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) 把 src 复制进 public/src，避免生产环境 ../src/*.js 404
      - name: Bundle src into public
        run: |
          rm -rf public/src
          mkdir -p public/src
          cp -R src/* public/src/

      # 2) 准备 vendor 目录并下载引擎产物（私库 latest release）
      - name: Prepare vendor
        run: mkdir -p public/vendor

      - name: Download engine bundle
        run: |
          echo "Downloading engine from ${OWNER}/${ENGINE_REPO}@${ENGINE_TAG}"
          gh release download "${ENGINE_TAG}" \
            --repo "${OWNER}/${ENGINE_REPO}" \
            --pattern "ems-engine.min.js" \
            --dir "public/vendor"
          ls -l public/vendor
        env:
          GH_TOKEN: ${{ env.ENGINE_PAT }}

      # 3) 上传静态站点工件
      - name: Upload artifact (static site)
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
