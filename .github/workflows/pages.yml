name: Build & Deploy Pages (private engine required)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

# æ ¹æ®ä½ çš„å®é™…æƒ…å†µæ”¹åŠ¨è¿™å››ä¸ªå€¼ï¼ˆè‹¥ç»„ç»‡/ä»“åº“åä¸åŒï¼‰
env:
  ENGINE_OWNER: enxpower            # â† ä½ çš„ç»„ç»‡/è´¦å·
  ENGINE_REPO: ems-engine           # â† ç§åº“å
  ENGINE_TAG:  latest               # â† ç§åº“ release çš„ tagï¼ˆå»ºè®® latest æˆ– vX.Y.Zï¼‰
  ENGINE_ASSET: ems-engine.min.js   # â† release é‡Œçš„æ„å»ºäº§ç‰©æ–‡ä»¶åï¼ˆå¿…é¡»åŒ¹é…ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å°† src/ å¤åˆ¶åˆ° public/src/ï¼ˆé¡µé¢ä¸­ç”¨ ./src/*.jsï¼‰
      - name: Bundle src into public/src
        run: |
          mkdir -p public/src
          rsync -a --delete src/ public/src/ || true

      - name: Ensure vendor dir
        run: mkdir -p public/vendor

      # ğŸ” æ ¡éªŒ Token å­˜åœ¨ï¼ˆå¿…é¡»æœ‰ ENGINE_READ_TOKENï¼Œå¦åˆ™ç›´æ¥å¤±è´¥ï¼‰
      - name: Verify secret is present
        run: |
          if [ -z "${{ secrets.ENGINE_READ_TOKEN }}" ]; then
            echo "âŒ Missing repository secret ENGINE_READ_TOKEN"
            exit 2
          fi
          echo "âœ… ENGINE_READ_TOKEN is present (value hidden)"

      # â¬‡ï¸ å¼ºåˆ¶ä¸‹è½½ç§åº“å¼•æ“ï¼›å¤±è´¥å³ failï¼Œç¡®ä¿çº¿ä¸Šä¸€å®šä½¿ç”¨ç†è®ºå¼•æ“
      - name: Download private engine (MUST SUCCEED)
        env:
          GH_TOKEN: ${{ secrets.ENGINE_READ_TOKEN }}
        run: |
          set -euo pipefail
          echo "==> Fetching ${ENGINE_OWNER}/${ENGINE_REPO} release: ${ENGINE_TAG}"
          gh release view "${ENGINE_TAG}" --repo "${ENGINE_OWNER}/${ENGINE_REPO}"

          echo "==> Downloading asset: ${ENGINE_ASSET}"
          gh release download "${ENGINE_TAG}" \
            --repo "${ENGINE_OWNER}/${ENGINE_REPO}" \
            --pattern "${ENGINE_ASSET}" \
            --dir "public/vendor"

          echo "==> Verifying asset exists"
          test -s "public/vendor/${ENGINE_ASSET}" || (echo "âŒ ${ENGINE_ASSET} not found or empty"; exit 66)
          ls -lh public/vendor

      # é…ç½® & ä¸Šä¼ é™æ€ç«™ç‚¹ï¼ˆpublic ç›®å½•ï¼‰
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact (public)
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
